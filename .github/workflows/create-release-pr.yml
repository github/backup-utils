---
# This workflow is triggered via repository_dispatch from the
# build-and-release workflow in backup-utils-private. It copies
# docs and README.md from backup-utils-private to a release dev branch
# in backup-utils, then creates a PR using GITHUB_TOKEN so that the
# PR author is github-actions[bot]. This allows the app token in
# backup-utils-private to approve the PR as a different actor.
name: Create Release PR

on:
  repository_dispatch:
    types: [create-release-pr]

permissions:
  contents: write
  pull-requests: write

jobs:
  create-release-pr:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ vars.RELEASE_CONTROLLER_APP_ID }}
          private-key: ${{ secrets.RELEASE_CONTROLLER_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: "backup-utils-private"

      - name: Checkout backup-utils
        uses: actions/checkout@v5

      - name: Checkout backup-utils-private
        uses: actions/checkout@v5
        with:
          token: ${{ steps.app-token.outputs.token }}
          repository: github/backup-utils-private
          path: './backup-utils-private'

      - name: Replace docs directory with backup-utils-private docs
        run: |
          rm -rf docs
          cp -r backup-utils-private/docs docs

      - name: Replace README.md with backup-utils-private README.md
        run: |
          rm README.md
          cp backup-utils-private/README.md README.md

      - name: Delete backup-utils-private
        run: |
          rm -rf backup-utils-private

      - name: Create release branch commit
        run: |
          version="${{ github.event.client_payload.version }}"
          branch="release/$version"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git checkout -B "$branch"
          git add docs README.md
          git commit --allow-empty -m "$version release"
          git push --force-with-lease --set-upstream origin "$branch"

      - name: Create or find release pull request
        id: release-pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          version="${{ github.event.client_payload.version }}"
          branch="release/$version"
          pr_number="$(gh pr list --head "$branch" --base master --json number --jq '.[0].number')"

          if [ -z "$pr_number" ]; then
            pr_url="$(gh pr create \
              --base master \
              --head "$branch" \
              --title "$version release" \
              --body "Automated release PR for v$version.")"
            pr_number="${pr_url##*/}"
          fi

          echo "number=$pr_number" >> "$GITHUB_OUTPUT"

      - name: Enable auto-merge on release pull request
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr merge \
            --squash \
            --auto \
            "${{ steps.release-pr.outputs.number }}"
